# Архитектура мультиагентной системы BolashakBot

## Обзор системы

BolashakBot использует мультиагентную архитектуру для обработки различных типов запросов пользователей. Каждый агент специализируется на конкретной области и может с разной степенью уверенности обрабатывать входящие сообщения.

## Архитектурная диаграмма

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   API Gateway   │    │   AgentRouter   │
│   (Chat UI)     │◄──►│   (/api/chat)   │◄──►│   (Маршрутизатор)│
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                       │
                                                       ▼
                        ┌──────────────────────────────────────────────┐
                        │               Агенты системы                 │
                        └──────────────────────────────────────────────┘
                                                       │
             ┌─────────────┬─────────────┬─────────────┼─────────────┬─────────────┐
             ▼             ▼             ▼             ▼             ▼             ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ AdmissionAgent│ │ScholarshipAgent│ │AcademicAgent │ │StudentLifeAgent│ │ GeneralAgent │
    │   (Поступление)│ │  (Стипендии)   │ │ (Учебный     │ │ (Студенческая  │ │   (Общие     │
    │               │ │                │ │  процесс)    │ │    жизнь)      │ │  вопросы)    │
    └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
             │             │             │             │             │
             └─────────────┴─────────────┼─────────────┴─────────────┘
                                         ▼
                        ┌─────────────────────────────────┐
                        │        MistralClient            │
                        │      (ИИ-обработка)             │
                        └─────────────────────────────────┘
                                         │
                                         ▼
                        ┌─────────────────────────────────┐    ┌─────────────────┐
                        │        База знаний              │◄──►│   Аналитика     │
                        │     (FAQ, Документы,            │    │  (Dashboard)    │
                        │     Веб-источники)              │    └─────────────────┘
                        └─────────────────────────────────┘
```

## Компоненты системы

### 1. AgentRouter (Маршрутизатор агентов)

**Файл:** `agents.py`

Центральный компонент, который:
- Получает сообщение пользователя
- Определяет наиболее подходящего агента
- Направляет запрос выбранному агенту
- Возвращает результат с метаданными

```python
class AgentRouter:
    def route_message(self, message: str, language: str = "ru") -> Dict[str, Any]:
        # Анализ уверенности каждого агента
        # Выбор лучшего агента
        # Обработка сообщения
```

### 2. Базовый класс агентов

**Файл:** `agents.py`

```python
class BaseAgent(ABC):
    @abstractmethod
    def can_handle(self, message: str, language: str = "ru") -> float:
        """Возвращает уверенность (0.0-1.0) в обработке сообщения"""
        
    @abstractmethod
    def get_system_prompt(self, language: str = "ru") -> str:
        """Возвращает системный промпт для агента"""
        
    def process_message(self, message: str, language: str = "ru") -> Dict[str, Any]:
        """Обрабатывает сообщение пользователя"""
```

### 3. Специализированные агенты

#### AdmissionAgent (Агент поступления)
- **Область:** Вопросы поступления, документы, экзамены, специальности
- **Ключевые слова:** поступление, зачисление, документы, экзамен, специальность
- **Системный промпт:** Специалист по поступлению

#### ScholarshipAgent (Агент стипендий)
- **Область:** Стипендии, финансовая поддержка, оплата
- **Ключевые слова:** стипендия, деньги, оплата, финансы, помощь
- **Системный промпт:** Специалист по стипендиям

#### AcademicAgent (Академический агент)
- **Область:** Учебный процесс, занятия, предметы, экзамены
- **Ключевые слова:** занятие, предмет, учеба, расписание, оценка
- **Системный промпт:** Специалист по учебному процессу

#### StudentLifeAgent (Агент студенческой жизни)
- **Область:** Общежитие, спорт, мероприятия, внеучебная деятельность
- **Ключевые слова:** общежитие, спорт, мероприятие, кружок, досуг
- **Системный промпт:** Специалист по студенческой жизни

#### GeneralAgent (Общий агент)
- **Область:** Общие вопросы об университете
- **Особенность:** Всегда готов ответить с низкой уверенностью (резервный агент)

## Алгоритм работы

### 1. Получение запроса
```
POST /api/chat
{
    "message": "Как поступить в университет?",
    "language": "ru"
}
```

### 2. Маршрутизация
```python
# 1. Каждый агент оценивает уверенность
confidences = [
    (AdmissionAgent, 0.9),      # Высокая уверенность
    (ScholarshipAgent, 0.1),    # Низкая уверенность
    (AcademicAgent, 0.2),       # Низкая уверенность
    (StudentLifeAgent, 0.1),    # Низкая уверенность
    (GeneralAgent, 0.3)         # Базовая уверенность
]

# 2. Выбирается агент с максимальной уверенностью
selected_agent = AdmissionAgent  # 0.9
```

### 3. Обработка сообщения
```python
result = selected_agent.process_message(message, language)
# {
#     'response': 'Для поступления в университет...',
#     'confidence': 0.9,
#     'agent_type': 'admission',
#     'agent_name': 'Агент поступления',
#     'context_used': True
# }
```

### 4. Логирование и аналитика
```python
user_query = UserQuery(
    user_message=message,
    bot_response=result['response'],
    language=language,
    agent_type=result['agent_type'],
    agent_name=result['agent_name'],
    agent_confidence=result['confidence'],
    context_used=result['context_used'],
    response_time=response_time
)
```

## Аналитика и мониторинг

### Метрики по агентам
- **Количество запросов** по каждому агенту
- **Среднее время ответа** для каждого агента
- **Уровень уверенности** агентов
- **Успешность** (высокая уверенность >= 0.5)
- **Распределение по языкам**

### Дашборд (Chart.js)
1. **Pie Chart:** Распределение запросов по агентам
2. **Doughnut Chart:** Распределение по языкам
3. **Bar Chart:** Время ответа агентов
4. **Bar Chart:** Успешность агентов
5. **Line Chart:** Активность агентов по дням

### API для аналитики
- `GET /admin/api/analytics/agents` - Детальная аналитика
- `GET /admin/api/analytics/summary` - Сводная аналитика

## Расширение системы

### Добавление нового агента

1. **Создать класс агента:**
```python
class NewTopicAgent(BaseAgent):
    def __init__(self):
        super().__init__(
            AgentType.NEW_TOPIC,  # Добавить в enum
            "Название агента",
            "Описание специализации"
        )
    
    def can_handle(self, message: str, language: str = "ru") -> float:
        # Логика определения релевантности
        pass
    
    def get_keywords(self, language: str = "ru") -> List[str]:
        # Ключевые слова для агента
        pass
    
    def get_system_prompt(self, language: str = "ru") -> str:
        # Системный промпт
        pass
```

2. **Добавить в AgentRouter:**
```python
class AgentRouter:
    def __init__(self):
        self.agents = [
            AdmissionAgent(),
            ScholarshipAgent(),
            AcademicAgent(),
            StudentLifeAgent(),
            NewTopicAgent(),  # Новый агент
            GeneralAgent()    # Должен быть последним
        ]
```

3. **Обновить AgentType enum:**
```python
class AgentType(Enum):
    ADMISSION = "admission"
    SCHOLARSHIP = "scholarship"
    ACADEMIC = "academic"
    STUDENT_LIFE = "student_life"
    NEW_TOPIC = "new_topic"  # Новый тип
    GENERAL = "general"
```

### Настройка агентов

#### Ключевые слова
Добавьте специфичные ключевые слова для улучшения точности маршрутизации:
```python
def get_keywords(self, language: str = "ru") -> List[str]:
    if language == "kz":
        return ["казахские", "ключевые", "слова"]
    return ["русские", "ключевые", "слова"]
```

#### Системные промпты
Настройте промпты для лучшего понимания контекста:
```python
def get_system_prompt(self, language: str = "ru") -> str:
    return """Детальный промпт с инструкциями для агента"""
```

#### Логика уверенности
Настройте алгоритм оценки релевантности:
```python
def can_handle(self, message: str, language: str = "ru") -> float:
    # Подсчет ключевых слов
    # Дополнительные проверки
    # Возврат уверенности 0.0-1.0
```

## База данных

### Обновленная модель UserQuery
```sql
CREATE TABLE user_queries (
    id INTEGER PRIMARY KEY,
    user_message TEXT NOT NULL,
    bot_response TEXT NOT NULL,
    language VARCHAR(5) DEFAULT 'ru',
    response_time FLOAT,
    agent_type VARCHAR(50),           -- Новое поле
    agent_name VARCHAR(100),          -- Новое поле
    agent_confidence FLOAT,           -- Новое поле
    context_used BOOLEAN DEFAULT 0,   -- Новое поле
    session_id VARCHAR(100),
    ip_address VARCHAR(45),
    user_agent VARCHAR(500),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## Производительность

### Оптимизации
1. **Кэширование контекста** из базы знаний
2. **Параллельная оценка** агентов
3. **Предварительная компиляция** ключевых слов
4. **Индексы базы данных** для аналитики

### Мониторинг
- Время отклика каждого агента
- Использование памяти
- Точность маршрутизации
- Удовлетворенность пользователей

## Безопасность

- Валидация входных данных
- Ограничение длины сообщений
- Защита от инъекций в промпты
- Аутентификация для админ-панели
- Логирование всех операций